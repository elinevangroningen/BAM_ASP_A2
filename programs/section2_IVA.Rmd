---
title: "section2_IVA"
author: "Eline van Groningen, Paola Priante, Valery Maasdamme, Yuhu Wang"
date: "9/25/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, 
                      comment = "", fig.height=2, fig.width=4, fig.align = "center")
```

# Instrumental Variable Analysis: Effect of Compulsory Schooling on Wages

Downloading the libraries 

```{r}
library(tidyverse)
library(stargazer)
library(dagitty)
library(gridExtra)
library(tinytex)
library(stargazer)
library(AER)
```

Example of code for plots 

```{r, fig.width=8}
g1.1 <- ggplot(data = hp, aes(LotArea, SalePrice)) +
  geom_point(size = 0.5) + 
  geom_smooth(method = "lm", color = "blue", alpha = 0.2)  + 
  geom_smooth(color = "red", alpha = 0.2) + 
  theme_bw() +
  labs(caption = "Figure 1.1") +
  theme(plot.caption =  element_text(hjust = 0.5, size = 12, face = "bold"))

g1.2 <- ggplot(data = hp, aes(Age, SalePrice)) +
  geom_point(size = 0.5) + 
  geom_smooth(method = "lm", color = "blue", alpha = 0.2)  + 
  geom_smooth(color = "red", alpha = 0.2) + 
  theme_bw() +
  labs(caption = "Figure 1.2") +
  theme(plot.caption =  element_text(hjust = 0.5, size = 12, face = "bold"))

grid.arrange(g1.1, g1.2, g1.3, nrow = 1)
```
Import the data
```{r}
setwd("C:/Users/Administrator/Desktop/NewStart/Courses/AdvancedStatisticsandProgramming/assignment2/github/BAM_ASP_A2/data")
da.IV <- read.csv("IV_dataset.csv", header = TRUE)
da.IV <- subset(da.IV,select = c("age","educ","lnwage","married","qob","SMSA","yob"))
## Subset the dataset so that we could focus on the variables above according to the order
```
## 1 
Two examples that could bias the effect:

Example One: The Education level of parents could bias the estimated education effect. It is because parents with high education level will be more likely to urge their children to have and finish the education. However, on the other hand, children with parents who have higher education level will be more likely to get higher salary when they go to work, since they can get better education environment from their family. Therefore, the education level of parents could bias the education effect.

Example Two: The living area could also be a factor that biases the education effect on wages. It is because people from rich area will have more opportunities to get more years of education. However, these people will also be more likely to get higher wages when they go to work because they could bulid better network in this area, which causes the bias estimation of the education effect on wages.

##2
Present summary statistics of the data

```{r}
stargazer(da.IV,type = "text")
summary(as.factor(da.IV$married))
```
From the statistics description above we could see, there are 329509 observations in the dataset, and the average age, education years, lnwage for all observations are 44.65, 12.77 and 5.9 respectively.

##3
Test if the quarter of birth(qob) meets the relevance criterion.
```{r}
da.IV$married <- as.factor(da.IV$married)
da.IV$qob <- as.factor(da.IV$qob)
da.IV$SMSA <- as.factor(da.IV$SMSA)
da.IV$yob <- as.factor(da.IV$yob)
#To change those variables which should be factor variables into factor vaiables.

g1.1 <- ggplot(data = da.IV, aes(qob, educ)) +
  geom_point(size = 0.5) + 
  geom_smooth(method = "lm", color = "blue", alpha = 0.2)  + 
  theme_bw() +
  labs(caption = "Figure 2.1") +
  geom_boxplot() + 
  theme(plot.caption =  element_text(hjust = 0.5, size = 12, face = "bold")) + 
  labs(x = "Quarter of Birth", y = "Education(in years)")
g1.1

rsltIV <- ivreg(lnwage ~ educ|qob,data = da.IV)
summary(rsltIV, diagnostics = TRUE)
```
According to the boxplot, we can hardly see there is a strong correlation between the instrumental variable(qob) and the causal variable(educ). Therefore, we need to run a weak instruments test, which gets us a p-value < 2e-16. In terms of this p-value, we can reject the Null hypothesis, which indicates there should be a strong relevance between qob and educ.

```{r}
dir <- "C:/Users/ppria/Documents/BAM_ASP_A2/data/"
da.IV <- read.csv(file=paste0(dir, "IV_dataset.csv"), header=TRUE)
da.IV <- subset(da.IV,select = c("age","educ","lnwage","married","qob","SMSA","yob"))

```
##4
IV regression analysis of the effect of education (in years) on log wages using quarter of birth as instrument variable: The quarter of birth partially influences the years of education. We use the variation that qob has on education to estimate the effect of education on weekly earnings. 
Tables presented below show that an extra year of education for people in the United States born between 1930-1939, leads to a 0.103% increase in weekly earnings. With a p-vale < 0.05, the estimated coefficient is statistically significant. 

```{r}
library(ivpack)
rslt2SLS.A <- ivreg(lnwage ~ educ | qob , data=da.IV)
summary(rslt2SLS.A)
stargazer(rslt2SLS.A, type= "text")
```
When adding marriage status and the indicator of living situation as control variables, there is a  decrease on the estimated coefficient from 0.103% to 0.1% with slightly lower standard errors still significant at 5% significance level. 
```{r}
rslt2SLS.A <- ivreg(lnwage ~ educ + married + SMSA | married + SMSA + qob , data=da.IV)
summary(rslt2SLS.A)
stargazer(rslt2SLS.A, type= "text")
```
Moreover, the use of robust standard errors does no have a critical effect on the statistical inference of the estimated coefficient of "Education" nor the control variables "Married and SMSA".
```{r}
#Robust standard errors
modelIV <- ivreg(lnwage ~ educ + married + SMSA | married + SMSA + qob , data=da.IV)
summary(modelIV)
#Standard  errors (superfluous  in the  case of  seBasic)
seBasic  <- sqrt(diag(vcov(modelIV)))
seWhite  <- sqrt(diag(vcovHC(modelIV , type="HC0")))
# Make  table  with  stargazer
stargazer(modelIV , modelIV ,align=TRUE , no.space=TRUE ,intercept.bottom = FALSE ,se = list(seBasic , seWhite), type= "text")
summary(modelIV , modelIV ,align=TRUE , no.space=TRUE ,intercept.bottom = FALSE ,se = list(seBasic , seWhite))
```